name: Weekly issue with vulnerabilities

on:
  schedule:
    - cron: "0 9 * * 1"
  workflow_dispatch:

jobs:
  create-weekly-issue:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      security-events: read
    steps:
      - name: Get today
        id: date
        run: echo "today=$(date -u +'%Y-%m-%d')" >> $GITHUB_OUTPUT
        
      - name: Fetch Dependabot vulnerabilities
        id: dependabot
        run: |
          alerts=$(gh api repos/${{ github.repository }}/dependabot/alerts \
            --paginate --jq '.[] | select(.security_vulnerability.severity=="high" or .security_vulnerability.severity=="critical") | 
            " - <span style=\"background-color:" + (if .security_vulnerability.severity == "critical" then "red" else "orange" end) + ";color:white;padding:2px 6px;border-radius:10px;font-weight:bold;\">" + .security_vulnerability.severity + "</span> " + .html_url')
          if [ -z "$alerts" ]; then
            echo "alerts=âœ… None found" >> $GITHUB_OUTPUT
          else
            {
              echo "alerts<<EOF"
              echo "$alerts"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.PAT }}

      - name: Fetch CodeQL vulnerabilities
        id: codeql
        run: |
          alerts=$(gh api repos/${{ github.repository }}/code-scanning/alerts \
            --paginate --jq '.[] | select(.rule.severity=="high" or .rule.severity=="critical") | 
            " - <span style=\"background-color:" + (if .rule.severity == "critical" then "red" else "orange" end) + ";color:white;padding:2px 6px;border-radius:10px;font-weight:bold;\">" + .rule.severity + "</span> " + .html_url')
          if [ -z "$alerts" ]; then
            echo "alerts=âœ… None found" >> $GITHUB_OUTPUT
          else
            {
              echo "alerts<<EOF"
              echo "$alerts"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.PAT }}

      - name: Create weekly issue
        run: |
          body=$(cat <<EOF
          ### ðŸ”’ Dependabot vulnerabilities (High/Critical)
          ${{ steps.dependabot.outputs.alerts }}

          ### ðŸ”’ CodeQL vulnerabilities (High/Critical)
          ${{ steps.codeql.outputs.alerts }}
          EOF
          )

          gh issue create \
            --repo ${{ github.repository }} \
            --title "[tech-debt] ${{ github.repository }} - ${{ steps.date.outputs.today }}" \
            --body "$body" \
            --label "bug" \
            --milestone "1.0.0"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
